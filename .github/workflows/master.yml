name: Release

on:
  push:
    branches:
      - main
      - ci

env:
  REGISTRY_USER: evalsocket
  REGISTRY_TOKEN: ${{ secrets.REGISTRY_TOKEN }}
  FLYTE_ENDPOINT: ${{ secrets.FLYTE_ENDPOINT }}
  CLIENT_ID: ${{ secrets.CLIENT_ID }}
  CLIENT_SECRET: ${{ secrets.CLIENT_SECRET }}
  DOCKER_BUILDKIT: 1

jobs:
  bump_version:
    name: bump-version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.bump_version.outputs.tag }}
    steps:
      - uses: actions/checkout@v2
        with:
          fetch-depth: "0"
      - name: Bump version and push tag
        id: bump_version
        uses: anothrNick/github-tag-action@1.17.2
        env:
          GITHUB_TOKEN: ${{ secrets.EVALSCKET_PAT }}
          WITH_V: true
          RELEASE_BRANCHES: main

  dagger:
    runs-on: ubuntu-latest
    needs: bump_version
    steps:
      - name: Clone repository
        uses: actions/checkout@v2

      - name: Update Project
        uses: dagger/dagger-for-github@v2
        with:
          install-only: true

      - name: Build & Push Docker Images
        run: |
          dagger project update
          dagger do push -l debug --log-format plain --with 'actions: params: image: tag: "${{ needs.bump_version.outputs.version }}"'

      - name: Serialize & Register Package
        run: |
          dagger do register -l debug --log-format plain --with 'actions: params: image: tag: "${{ needs.bump_version.outputs.version }}"'
